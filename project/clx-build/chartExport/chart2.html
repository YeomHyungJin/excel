<!DOCTYPE html>

<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            width: 400px;
            height: 300px;
            margin: auto;
            /* margin-top: 100px; */
        }

        #btn_chart_excel_download {
            border: 0; background-color: #007f1b; color: white; font-weight: bold; padding: 5px; border-radius: 10px;
        }
    </style>
    <script src="../chartExport/jquery-3.5.1.min.js"></script>
    <script src="../chart-3d/highcharts.js"></script>
    <script src="../chartExport/exceljs.min.js"></script>
    <script src="../chartExport/FileSaver.min.js"></script>
    <script src="../chartExport/canvg.js"></script>
    <script src="../chartExport/exporting.js"></script>
    
    <body>
    <input type="button" value="엑셀 다운로드" id="btn_chart_excel_download" class="btn_excel" />
    <div id="container" style="height: 300px;"></div>
    <canvas id="myChart" width="100" height="100" hidden=true></canvas>
    </body>
    
    <script>
    
    function sendData(arg){
    	
		////////////////////////////////////////////////////////////////////////////////////////////////////
    	var val1 = [];		// 차트의 x축에 해당하는 값
		var val2 = [];		// 차트의 y축에 해당하는 값 1
		var val3 = [];		// 차트의 y축에 해당하는 값 2	
		var val4 = [];		// 차트의 y축에 해당하는 값 3	
		
		// 화면에서 넘어온 arg(jsonArray)값을 배열로 변환
		for(var i = 0 ; i < arg.length ; i ++){
			
			val1.push(Object.values(arg[i])[0].substr(0,4)+'년'+Object.values(arg[i])[0].substr(4,2)+'월');
			val2.push(parseInt(Object.values(arg[i])[1]));
			val3.push(parseInt(Object.values(arg[i])[2]));
			val4.push(parseInt(Object.values(arg[i])[3]));
		}
		////////////////////////////////////////////////////////////////////////////////////////////////////
		
		// 차트에 넣을 series 값 생성
		var jsonArrayChartData = new Array();	// 차트에 넣을 series 값(json값을 배열에 담은 변수)
		var name = ['수학점수', '영어점수', '국어점수'];
		var color = ['red', 'blue', 'yellow'];			// 차트 색상 
		
		// for문 1부터 시작한 이유 : val1은 x축 해당하여 제외 그래서 val2부터 시작함.
		for(var i = 1 ; i < Object.keys(arg[0]).length ; i ++){
			
			// 차트 데이터 생성
			var jsonChartData = {};
			jsonChartData.name = name[i-1];
			jsonChartData.data = eval("val"+(i+1));
			jsonChartData.stack = Object.keys(arg[0])[i];
			jsonChartData.color = color[i-1];
			jsonArrayChartData.push(jsonChartData);
		}
		////////////////////////////////////////////////////////////////////////////////////////////////////
		
		// header
		// {header:'date', key:'date', width:50}  예) x축 값
		// {header:'mathScore', key:'mathScore', width:50}  예) 값1
		// {header:'engScore', key:'engScore', width:50}  예) 값2
		
		/* var jsonArrayHeader = new Array();	// (jsonArray version)엑셀에서의 header 값 */
		var arrayHeader = [];				// (array version) 엑셀에서의 header 값
		
		for(var i = 0 ; i < Object.keys(arg[0]).length ; i++){
			
			// jsonArray로 header 표출
			/* var jsonHeader = {};
			jsonHeader.header = Object.keys(arg[0])[i];
			jsonHeader.key = Object.keys(arg[0])[i];
			jsonHeader.width = 50;
			jsonArrayHeader.push(jsonHeader); */
			
			// Array로 header 표출
			arrayHeader.push(Object.keys(arg[0])[i]);
		}
		////////////////////////////////////////////////////////////////////////////////////////////////////
		
		var arrayData = [];	// 엑셀에 넣을 헤더를 제외한 data 변수 (헤더는 바로 위 참조)
		
		for (var i = 0; i < arg.length; i++) {
			
		    arrayData.push(Object.values(arg[i]));
		}
		////////////////////////////////////////////////////////////////////////////////////////////////////
		// 차트 그리기
    	const chart = new Highcharts.Chart({
    		
    	    chart: {
    	    	type: 'line',
    	        renderTo: 'container',
    	        zoomType: 'x', // x축이 줌인이 가능하게 설정
    			panning: true,
    			panKey: 'shift'
    	    },
    	    title: {
    	        text: '2022년도 나의 기말고사 점수'
    	    },
    	    xAxis: {
    	        categories: val1,
    	    },
    	    yAxis: {
    	        allowDecimals: false,
    	        min: 0,
    	        title: {
    	            text: '기말고사 점수',
    	            skew3d: true
    	        }
    	    },
    	    credits:{
    			enabled:false
    		},
    	    tooltip: {
    	    	shared:true,	// 하나의 영역을 공유
    	    	headerFormat: '<b>{point.key}</b><br>',
    	        pointFormat: '<span style="color:{series.color}">\u25CF</span> {series.name}: {point.y}점<br>'
    	    },
    	    plotOptions: {
    	        column: {
    	            stacking: 'normal',
    	            depth: 40
    	        }
    	    },
    	    series: jsonArrayChartData
    	});
		////////////////////////////////////////////////////////////////////////////////////////////////////
		// canvas 영역(myChart)에 위에 그린 차트 이미지화 하여 넣는 작업
	    canvg(document.getElementById('myChart'), chart.getSVG());
		// canvas 영역 property 변수에 담기
	    var canvas = document.getElementById("myChart");
	    
		// 버튼 클릭시 엑셀 다운로드됨
	    $(function() {
	        $("#btn_chart_excel_download").click(function() {
	            // 캔버스에 그려진 이미지를 data url로 변환
	            var base64Image = canvas.toDataURL(1.0);
	            
	            // excel js 객체 생성
	            var workbook = new ExcelJS.Workbook();
	
	            // 차트 워크시트 생성
	            var worksheet = workbook.addWorksheet('차트');
	            
	         	// 그리드 워크시트 생성
	            /* var worksheet2 = workbook.addWorksheet('그리드'); */
	         	
	         	// 시트 삭제(권한에맞게)
	         	/* workbook.removeWorksheet('그리드'); */
	
	            // 흰 배경을 만들기 위해 셀 병합
	            worksheet.mergeCells('A1:C15');
	
	            // 이미지 등록
	            var imageId = workbook.addImage({
	                base64: base64Image,
	                extension: 'png',
	            });
				
	            // 병합했던 셀에 이미지 추가 (엑셀 파일 열면 위치 이동가능)
	            worksheet.addImage(imageId, 'A1:C15');
	            
	            // 워크시트2번에 헤더 영역 binding
	            /* worksheet2.columns = jsonArrayHeader; */
	            // 워크시트2번에 데이터 영역 binding
	            /* const data = arg; */
	            // 엑셀에 데이터 추가
	            /* data.map((item, index)=>{
	            	worksheet2.addRow(item);
	            }); */
	            
	            worksheet.columns = [
	            	{width : 30}, {width : 30}, {width : 30}, {width : 30}
				]
	            
	            // 워크시트1번에 헤더 영역 binding (차트와 그리드 같이)
	            worksheet.getRow(17).values = arrayHeader;
	            
	            // 헤더 꾸미기
	            for(var i = 1 ; i <= Object.keys(arg[0]).length; i ++){
	            	// 색채우기
	            	worksheet.getRow(17).getCell(i).fill = {
		                type: 'pattern',
		                pattern:'solid',
		                fgColor:{argb:'7CEEFF'}
		            };
	            	// 정렬
	            	worksheet.getRow(17).getCell(i).alignment = {
           		     	vertical: 'middle', horizontal: 'center'
           		    };
	            	// 높이 조정
	            	worksheet.getRow(17).height = 30;
	            	// 폰트
	            	worksheet.getRow(17).getCell(i).font = {
           		        bold: true,
           		        size: 15
           		    };
	            	// 테두리
	            	worksheet.getRow(17).getCell(i).border = {
            	        top: {style:'thin', color:{argb:'000000'}},
            	        left: {style:'thin', color:{argb:'000000'}},
            	        bottom: {style:'thin', color:{argb:'000000'}},
            	        right: {style:'thin', color:{argb:'000000'}}
	            	};
	            }
	            
	         	// 워크시트1번에 데이터 영역 binding (차트와 그리드 같이)
	            worksheet.addRows(arrayData);
	         	
	            // 파일 다운로드
	            workbook.xlsx.writeBuffer().then(function(data) {
	                let blob = new Blob([data], { type: "application/vnd.ms-excel;charset=utf-8" });
	                saveAs(blob, "gridChart.xlsx");
	            });
	        });
	    });
    }
    
    </script> 
</head>

<body>
</body>

</html>